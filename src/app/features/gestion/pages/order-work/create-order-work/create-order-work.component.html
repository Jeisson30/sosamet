<div class="order-work-container">
  <h2 class="login-title">Crear Orden de Trabajo</h2>
  <!-- Fila 1 -->
  <div class="form-grid three-columns">
    <p-floatLabel class="form-field">
      <input
        id="consecutivo"
        pInputText
        class="w-full"
        [(ngModel)]="consecutivo"
      />
      <label for="consecutivo">Consecutivo</label>
    </p-floatLabel>

    <p-floatLabel class="form-field">
      <p-dropdown
        id="empresa"
        [options]="companies"
        [(ngModel)]="empresaSelectedId"
        optionValue="id"
        class="w-full"
        optionLabel="nombre_empresa"
        optionValue="id"
      >
      </p-dropdown>
      <label for="empresa">Empresa Asociada</label>
    </p-floatLabel>

    <p-floatLabel class="form-field">
      <p-calendar
        id="fechaEntrega"
        [(ngModel)]="fechaEntrega"
        dateFormat="dd/mm/yy"
        class="w-full"
      >
      </p-calendar>
      <label for="fechaEntrega">Fecha Entrega</label>
    </p-floatLabel>
  </div>

  <!-- Fila 2 -->
  <div class="form-grid one-column">
    <p-floatLabel class="form-field">
      <p-dropdown
        id="encargado"
        [options]="workUsers"
        [(ngModel)]="userSelected"
        optionValue="id_usuario"
        class="w-full"
        optionLabel="displayName"
      >
      </p-dropdown>
      <label for="encargado">Encargado</label>
    </p-floatLabel>
  </div>

  <!-- Fila 3 -->
  <div class="form-grid one-column">
    <p-floatLabel class="form-field">
      <textarea
        id="observaciones"
        pInputTextarea
        rows="3"
        class="w-full"
        [(ngModel)]="observaciones"
      >
      </textarea>
      <label for="observaciones">Observaciones</label>
    </p-floatLabel>
  </div>

  <!-- Botones -->
  <div class="form-button-row">
    <p-button
      label="Adjuntar Acta de Medida"
      icon="pi pi-paperclip"
      class="custom-btn"
      (onClick)="onAdjuntarActa()"
    >
    </p-button>

    <p-button
      label="Subir Archivo Excel"
      icon="pi pi-upload"
      class="custom-btn"
      (onClick)="fileInput.click()"
    >
    </p-button>

    <input
      #fileInput
      type="file"
      hidden
      accept=".xlsx,.xls"
      (change)="onFileSelected($event)"
    />
  </div>

  <!-- ================== DETALLE DE ITEMS ================== -->
  <div class="items-container">
    <div *ngIf="items.length === 0" class="empty-state">
      <p>No hay items cargados</p>
      <button
        pButton
        icon="pi pi-plus"
        label="Agregar Item"
        class="custom-btn"
        (click)="addItemRow()"
      ></button>
    </div>

    <div class="item-card" *ngFor="let row of items; let i = index; trackBy: trackByIndex">
      <div class="item-header">
        <span>Item {{ i + 1 }}</span>
      </div>

      <div class="items-row">
        <input pInputText placeholder="Ref" [(ngModel)]="row.ref" />

        <input pInputText placeholder="No Contrato" [(ngModel)]="row.no_contrato" />

        <input pInputText placeholder="Obra" [(ngModel)]="row.obra" />

        <input pInputText placeholder="Item" [(ngModel)]="row.item" />

        <input
          pInputText
          placeholder="DescripciÃ³n"
          [(ngModel)]="row.descripcion"
        />

        <p-floatLabel>
          <input
            type="number"
            pInputText
            [(ngModel)]="row.cantidad"
          />
          <label>Cant</label>
        </p-floatLabel>

        <input pInputText placeholder="UM" [(ngModel)]="row.um" />

        <p-floatLabel>
          <input type="number" pInputText [(ngModel)]="row.ancho" />
          <label>Ancho</label>
        </p-floatLabel>

        <p-floatLabel>
          <input type="number" pInputText [(ngModel)]="row.alto" />
          <label>Alto</label>
        </p-floatLabel>

        <input
          pInputText
          placeholder="Observaciones"
          [(ngModel)]="row.observaciones"
        />
      </div>

      <div class="item-actions">
        <button
          pButton
          icon="pi pi-plus"
          class="btn-add"
          (click)="addItemRow()"
          *ngIf="i === items.length - 1"
        >+</button>

        <button
          pButton
          icon="pi pi-trash"
          class="btn-remove"
          *ngIf="items.length > 1"
          (click)="removeItemRow(i)"
        >-</button>
      </div>
    </div>
  </div>

  <!-- ================== GUARDAR ================== -->
  <div class="save-row">
    <p-button
      label="Guardar"
      icon="pi pi-save"
      class="custom-btn"
      [loading]="loading"
      [disabled]="loading"
      (onClick)="guardarOrden()"
    ></p-button>
  </div>
</div>
